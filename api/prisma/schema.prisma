generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @db.UniqueIdentifier
  email     String   @unique @db.NVarChar(255)
  name      String   @db.NVarChar(255)
  role      String   @db.NVarChar(100)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @updatedAt @db.DateTime2
  requests  Request[]
}

model Facility {
  id   String @id @default(uuid()) @db.UniqueIdentifier
  name String @unique @db.NVarChar(255)
  sites Site[]
}

model Site {
  id         String   @id @default(uuid()) @db.UniqueIdentifier
  name       String   @db.NVarChar(255)
  facility   Facility @relation(fields: [facilityId], references: [id])
  facilityId String   @db.UniqueIdentifier
  instruments Instrument[]
}

model Instrument {
  id           String @id @default(uuid()) @db.UniqueIdentifier
  serialNumber String @unique @db.NVarChar(255)
  site         Site   @relation(fields: [siteId], references: [id])
  siteId       String @db.UniqueIdentifier
  requests     Request[]
}

model Request {
  id           String        @id @default(uuid()) @db.UniqueIdentifier
  serialNumber String        @db.NVarChar(255)
  facility     String        @db.NVarChar(255)
  site         String        @db.NVarChar(255)
  description  String        @db.NVarChar(2000)
  status       String        @db.NVarChar(50)
  createdAt    DateTime      @default(now()) @db.DateTime2
  updatedAt    DateTime      @updatedAt @db.DateTime2
  createdBy    User?         @relation(fields: [createdById], references: [id])
  createdById  String?       @db.UniqueIdentifier
  comments     RequestComment[]
  // Relation to Instrument (optional) to satisfy Instrument.requests back-relation
  instrument   Instrument?   @relation(fields: [instrumentId], references: [id])
  instrumentId String?       @db.UniqueIdentifier
  // Back-relation for WorkflowStep.request
  workflowSteps WorkflowStep[]
}

model RequestComment {
  id        String   @id @default(uuid()) @db.UniqueIdentifier
  request   Request  @relation(fields: [requestId], references: [id])
  requestId String   @db.UniqueIdentifier
  comment   String   @db.NVarChar(2000)
  createdAt DateTime @default(now()) @db.DateTime2
}

model WorkflowStep {
  id        String   @id @default(uuid()) @db.UniqueIdentifier
  request   Request  @relation(fields: [requestId], references: [id])
  requestId String   @db.UniqueIdentifier
  assignee  String   @db.NVarChar(255)
  status    String   @db.NVarChar(50)
  comment   String?  @db.NVarChar(2000)
  createdAt DateTime @default(now()) @db.DateTime2
}
